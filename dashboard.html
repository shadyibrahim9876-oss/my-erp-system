<!DOCTYPE html>
<html lang="en" dir="ltr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systemize - Ultimate Enterprise OS</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@500;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Poppins', 'sans-serif'], 
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: {
                        bgBody: '#EBF1F5', cardWhite: '#FFFFFF', textPrimary: '#1A1A1A', textSecondary: '#64748B',
                        darkBgBody: '#0F172A', darkCard: '#1E293B', darkTextPrimary: '#F8FAFC', darkTextSecondary: '#94A3B8',
                        accentPrimary: '#714B67', clockText: '#4A3B45',
                    },
                    boxShadow: {
                        'soft': '0 4px 20px rgba(0, 0, 0, 0.03)',
                        'float': '0 10px 40px -10px rgba(0,0,0,0.1)',
                        'glow': '0 0 15px rgba(113, 75, 103, 0.4)',
                        'inner-sm': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.06)',
                        'aurora': '0 8px 32px 0 rgba(31, 38, 135, 0.15)',
                    },
                    zIndex: { 'island': '9999', 'popover': '150', 'dropdown': '130', 'header': '100', 'subheader': '90', 'sidebar': '80', 'overlay': '70' },
                    transitionTimingFunction: { 'spring': 'cubic-bezier(0.25, 0.8, 0.25, 1)', 'smooth': 'cubic-bezier(0.4, 0, 0.2, 1)' }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="assets/css/styles.css">

</head>
<body class="bg-bgBody dark:bg-darkBgBody text-textPrimary dark:text-darkTextPrimary overflow-hidden h-screen w-screen selection:bg-accentPrimary selection:text-white">

<svg width="0" height="0" style="position: absolute;">
  <defs>
    <linearGradient id="homeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#00C6FB" />
      <stop offset="50%" stop-color="#9D50BB" />
      <stop offset="100%" stop-color="#FF416C" />
    </linearGradient>
  </defs>
</svg>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useContext, createContext, useRef, useCallback } = React;

    /* ========================================
    Sound & Utility Functions
    وظائف الصوت والأدوات المساعدة
    ========================================
    */
    const audioRef = { ctx: null };
    const playSound = (type) => {
        try {
            if (!audioRef.ctx) audioRef.ctx = new (window.AudioContext || window.webkitAudioContext)();
            const ctx = audioRef.ctx;
            if (ctx.state === 'suspended') ctx.resume();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            const freq = type === 'error' ? 150 : type === 'success' ? 600 : 400;
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(freq/2, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.05, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.15);
        } catch (e) {}
    };

    /* ========================================
    Icon Component
    مكون الأيقونات
    ========================================
    يقوم بجلب الأيقونات من مكتبة Lucide ديناميكياً
    */
    const Icon = ({ name, size = 20, className = "", strokeWidth = 2, style={} }) => {
        const containerRef = useRef(null);
        useEffect(() => {
            if (window.lucide && window.lucide.icons && containerRef.current) {
                const iconName = name.replace(/(^\w|-\w)/g, (g) => g.replace('-','').toUpperCase());
                const iconData = window.lucide.icons[iconName];
                if (iconData) {
                    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round" class="${className}">${iconData.map(child => `<${child[0]} ${Object.entries(child[1]).map(([k,v]) => `${k}="${v}"`).join(' ')} />`).join('')}</svg>`;
                    containerRef.current.innerHTML = svg;
                    const svgEl = containerRef.current.querySelector('svg');
                    if(svgEl && style) Object.assign(svgEl.style, style);
                }
            }
        }, [name, size, className, strokeWidth, style]);
        return <span ref={containerRef} className="inline-flex items-center justify-center"></span>;
    };

    /* ========================================
    Custom SVG Icons (Application Icons)
    أيقونات التطبيقات المخصصة
    ========================================
    */
    const iconSize = 56;
    const ShippingIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <path d="M4 24H44V36C44 38.2091 42.2091 40 40 40H8C5.79086 40 4 38.2091 4 36V24Z" fill="#60A5FA" opacity="0.8"/> <path d="M8 24V12C8 9.79086 9.79086 8 12 8H28V24H8Z" fill="#3B82F6"/> <path d="M28 24V14L40 24H28Z" fill="#2563EB"/> <circle cx="14" cy="40" r="4" fill="#1E40AF"/> <circle cx="34" cy="40" r="4" fill="#1E40AF"/> </svg> );
    const OperationsIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <circle cx="24" cy="24" r="18" stroke="#F59E0B" strokeWidth="4"/> <circle cx="24" cy="24" r="8" fill="#FBBF24"/> <path d="M24 6V12M24 36V42M42 24H36M12 24H6" stroke="#D97706" strokeWidth="4" strokeLinecap="round"/> </svg> );
    const AccountingIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <circle cx="12" cy="12" r="8" fill="#FDBA74" /> <circle cx="28" cy="28" r="8" fill="#2DD4BF" /> <rect x="6" y="30" width="34" height="8" rx="4" transform="rotate(-45 6 30)" fill="#8B5CF6" opacity="0.9" /> </svg> );
    const HRIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <circle cx="24" cy="12" r="8" fill="#F472B6"/> <path d="M8 40C8 31.1634 15.1634 24 24 24C32.8366 24 40 31.1634 40 40" stroke="#EC4899" strokeWidth="4" strokeLinecap="round"/> <circle cx="38" cy="12" r="4" fill="#FBCFE8"/> <circle cx="10" cy="12" r="4" fill="#FBCFE8"/> </svg> );
    const SalesIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <path d="M4 40L14 24L24 32L44 8" stroke="#10B981" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"/> <path d="M44 8H32M44 8V20" stroke="#10B981" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"/> <circle cx="4" cy="40" r="3" fill="#34D399"/> <circle cx="14" cy="24" r="3" fill="#34D399"/> <circle cx="24" cy="32" r="3" fill="#34D399"/> </svg> );
    const ReportsIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <rect x="10" y="6" width="28" height="36" rx="4" fill="#E2E8F0"/> <rect x="16" y="14" width="16" height="4" rx="2" fill="#94A3B8"/> <rect x="16" y="22" width="16" height="4" rx="2" fill="#94A3B8"/> <rect x="16" y="30" width="10" height="4" rx="2" fill="#64748B"/> <path d="M30 32L42 42" stroke="#3B82F6" strokeWidth="4" strokeLinecap="round"/> <circle cx="40" cy="40" r="6" stroke="#3B82F6" strokeWidth="3" fill="none"/> </svg> );
    const LiveChatIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <rect x="6" y="8" width="20" height="18" rx="6" fill="#60A5FA" /> <path d="M6 20L2 24V14L6 14" fill="#60A5FA" /> <rect x="14" y="14" width="20" height="18" rx="6" fill="#F472B6" style={{mixBlendMode: 'multiply'}} /> <path d="M34 26L38 30V20L34 20" fill="#F472B6" style={{mixBlendMode: 'multiply'}} /> </svg> );
    const WebsiteIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <circle cx="20" cy="20" r="16" stroke="#3B82F6" strokeWidth="3" fill="#BFDBFE" fillOpacity="0.3"/> <path d="M4 20H36" stroke="#3B82F6" strokeWidth="2"/> <ellipse cx="20" cy="20" rx="6" ry="16" stroke="#3B82F6" strokeWidth="2" /> </svg> );
    const EcommerceIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <path d="M8 12L32 16L30 28H10L8 12Z" fill="#F472B6" opacity="0.8"/> <circle cx="14" cy="34" r="3" fill="#EC4899"/> <circle cx="26" cy="34" r="3" fill="#EC4899"/> <path d="M8 12H4V8H10" stroke="#EC4899" strokeWidth="3" strokeLinecap="round"/> </svg> );
    const ForumIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <rect x="4" y="8" width="24" height="20" rx="4" fill="#34D399" opacity="0.8"/> <rect x="12" y="16" width="24" height="20" rx="4" fill="#10B981" opacity="0.9"/> </svg> );
    const LMSIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <path d="M20 4L4 12L20 20L36 12L20 4Z" fill="#FBBF24"/> <path d="M4 12V28L20 36V20L4 12Z" fill="#F59E0B"/> <path d="M36 12V28L20 36V20L36 12Z" fill="#D97706"/> </svg> );
    const CRMIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <circle cx="20" cy="14" r="6" fill="#F87171"/> <path d="M8 34C8 26 12 22 20 22C28 22 32 26 32 34" stroke="#EF4444" strokeWidth="4" strokeLinecap="round"/> </svg> );
    const AnalyticsIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <rect x="6" y="24" width="6" height="12" rx="2" fill="#06B6D4"/> <rect x="17" y="16" width="6" height="20" rx="2" fill="#0EA5E9"/> <rect x="28" y="8" width="6" height="28" rx="2" fill="#3B82F6"/> </svg> );
    const SupportIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <circle cx="20" cy="20" r="16" stroke="#14B8A6" strokeWidth="6"/> <circle cx="20" cy="20" r="8" fill="#14B8A6"/> </svg> );
    const ManagementIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <rect x="14" y="4" width="20" height="14" rx="2" fill="#6366F1"/> <path d="M24 18V28" stroke="#818CF8" strokeWidth="3"/> <rect x="4" y="28" width="16" height="12" rx="2" fill="#818CF8"/> <path d="M12 28V24H36V28" stroke="#818CF8" strokeWidth="3" strokeLinecap="round"/> <rect x="28" y="28" width="16" height="12" rx="2" fill="#818CF8"/> </svg> );
    const DashboardIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <rect x="4" y="4" width="14" height="14" rx="4" fill="#F87171"/> <rect x="22" y="4" width="14" height="14" rx="4" fill="#60A5FA"/> <rect x="4" y="22" width="14" height="14" rx="4" fill="#34D399"/> <rect x="22" y="22" width="14" height="14" rx="4" fill="#FBBF24"/> </svg> );
    const SettingsIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <circle cx="24" cy="24" r="10" stroke="#9CA3AF" strokeWidth="6"/> <circle cx="24" cy="24" r="4" fill="#4B5563"/> <path d="M24 2V8M24 40V46M46 24H40M8 24H2" stroke="#9CA3AF" strokeWidth="6" strokeLinecap="round"/> </svg> );
    const SystemizeAppIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"> <path d="M24 4L42 14V34L24 44L6 34V14L24 4Z" fill="#8B5CF6"/> <path d="M24 22L36 15M24 22L12 15M24 22V36" stroke="white" strokeWidth="3" strokeLinecap="round"/> </svg> );

    const DomesticIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"><path d="M24 44C24 44 40 32 40 18C40 9.16344 32.8366 2 24 2C15.1634 2 8 9.16344 8 18C8 32 24 44 24 44Z" fill="#10B981" opacity="0.9"/><circle cx="24" cy="18" r="8" fill="#34D399"/><path d="M24 14V22M20 18H28" stroke="white" strokeWidth="3" strokeLinecap="round"/></svg> );
    const InternationalIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"><circle cx="24" cy="24" r="20" fill="#3B82F6" opacity="0.9"/><path d="M4 24H44" stroke="#93C5FD" strokeWidth="3"/><path d="M24 4C24 4 32 14 32 24C32 34 24 44 24 44C24 44 16 34 16 24C16 14 24 4 24 4Z" stroke="#93C5FD" strokeWidth="3"/><path d="M38 14L10 34" stroke="white" strokeWidth="2" strokeDasharray="4 4"/></svg> );
    const SeaIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"><path d="M4 30L8 38H40L44 30H4Z" fill="#0284C7"/><rect x="10" y="16" width="8" height="14" fill="#EF4444"/><rect x="18" y="12" width="8" height="18" fill="#F59E0B"/><rect x="26" y="16" width="8" height="14" fill="#10B981"/><path d="M2 38C2 38 10 44 16 40C22 36 30 42 36 38C42 34 48 38 48 38" stroke="#7DD3FC" strokeWidth="4" strokeLinecap="round"/></svg> );
    const AirIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"><path d="M42 22C42 17.5817 38.4183 14 34 14H14C8.47715 14 4 18.4772 4 24C4 29.5228 8.47715 34 14 34H34C38.4183 34 42 30.4183 42 26V22Z" fill="#93C5FD"/><path d="M14 14C8.47715 14 4 18.4772 4 24C4 29.5228 8.47715 34 14 34V14Z" fill="#60A5FA"/><path d="M20 24L28 6H40L34 24H20Z" fill="#3B82F6"/><path d="M8 24L14 10H24L18 24H8Z" fill="#3B82F6"/><rect x="26" y="30" width="10" height="6" rx="3" fill="#1E40AF"/><circle cx="18" cy="22" r="2" fill="white" fillOpacity="0.7"/><circle cx="24" cy="22" r="2" fill="white" fillOpacity="0.7"/><circle cx="30" cy="22" r="2" fill="white" fillOpacity="0.7"/></svg> );
    const LandIcon = () => ( <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow"><rect x="4" y="14" width="26" height="20" rx="2" fill="#F59E0B"/><path d="M30 24H38L44 34H30V24Z" fill="#FCD34D"/><circle cx="12" cy="38" r="5" fill="#374151"/><circle cx="36" cy="38" r="5" fill="#374151"/><rect x="4" y="31" width="40" height="4" fill="#D97706" opacity="0.3"/></svg> );

    const SCMIcon = () => (
        <svg width={iconSize} height={iconSize} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className="icon-drop-shadow">
            <path d="M10 24H38" stroke="#F59E0B" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"/>
            <rect x="4" y="16" width="12" height="12" rx="2" fill="#FBBF24"/>
            <rect x="32" y="16" width="12" height="12" rx="2" fill="#10B981"/>
            <path d="M16 24L20 20M16 24L20 28" stroke="#FBBF24" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"/>
            <path d="M32 24L28 20M32 24L28 28" stroke="#10B981" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"/>
            <circle cx="24" cy="24" r="6" fill="#3B82F6"/>
            <path d="M24 20V28M20 24H28" stroke="white" strokeWidth="2" strokeLinecap="round"/>
        </svg>
    );

   /* ========================================
    6. إدارة الحالة العامة (Context API) - [معدل]
    ========================================
    */
    const AppContext = createContext();
    const AppProvider = ({ children }) => {
        const [darkMode, setDarkMode] = useState(false);
        const [sidebarOpen, setSidebarOpen] = useState(false);
        const [islandState, setIslandState] = useState({ active: false, type: 'info', message: '', sub: '' });
        const timeoutRef = useRef(null);

        // --- حالة الشريط الثانوي (جديد) ---
        // true = ظاهر، false = مخفي خلف الهيدر
        const [showSubHeader, setShowSubHeader] = useState(true); 

        // --- نظام التاريخ ---
        const [history, setHistory] = useState(['home']); 
        const [currentIndex, setCurrentIndex] = useState(0); 
        const activePage = history[currentIndex];

        const navigateTo = (pageId) => {
            if (pageId === activePage) return;
            const newHistory = history.slice(0, currentIndex + 1);
            newHistory.push(pageId);
            setHistory(newHistory);
            setCurrentIndex(newHistory.length - 1);
            // عند الانتقال لصفحة جديدة، نُظهر الشريط تلقائياً لو كان مخفياً (تجربة مستخدم أفضل)
            if (MODULE_NAV_DATA[pageId.split('_')[0]]) setShowSubHeader(true);
        };

        const goBack = () => { if (currentIndex > 0) setCurrentIndex(prev => prev - 1); };
        const goForward = () => { if (currentIndex < history.length - 1) setCurrentIndex(prev => prev + 1); };

        const toggleSidebar = () => setSidebarOpen(prev => !prev);
        const toggleSubHeader = () => setShowSubHeader(prev => !prev); // دالة التبديل

        const notify = useCallback((type, message, sub = "") => {
            playSound(type);
            if (timeoutRef.current) clearTimeout(timeoutRef.current);
            setIslandState({ active: true, type, message, sub });
            timeoutRef.current = setTimeout(() => setIslandState(prev => ({ ...prev, active: false })), 3000);
        }, []);

        useEffect(() => {
            if (darkMode) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        }, [darkMode]);

        return (
            <AppContext.Provider value={{ 
                darkMode, setDarkMode, 
                sidebarOpen, toggleSidebar, 
                activePage, navigateTo, goBack, goForward, 
                notify, islandState,
                canGoBack: currentIndex > 0,
                canGoForward: currentIndex < history.length - 1,
                showSubHeader, toggleSubHeader // تمرير الحالة والدالة
            }}>
                {children}
            </AppContext.Provider>
        );
    };

    /* ========================================
    App Data Definitions
    تعريف بيانات التطبيق والقوائم
    ========================================
    */
    const MASTER_APPS_DATA = [
        { id: 'shipping', label: 'Shipping', icon: <ShippingIcon />, desc: "Logistics & Delivery Management" },
        { id: 'scm', label: 'SCM (Supply Chain)', icon: <SCMIcon />, desc: "Supply Chain Management" },
        { id: 'operation', label: 'Operation', icon: <OperationsIcon />, desc: "Manufacturing & Inventory" },
        { id: 'accounting', label: 'Accounting', icon: <AccountingIcon />, desc: "Financial & Tax Management" },
        { id: 'hr', label: 'Human Resources', icon: <HRIcon />, desc: "Employees & Recruitment" },
        { id: 'sales', label: 'Sales', icon: <SalesIcon />, desc: "Quotations & Invoicing" },
        { id: 'crm', label: 'CRM', icon: <CRMIcon />, desc: "Customer Relationship Data" },
        { id: 'livechat', label: 'Live Chat', icon: <LiveChatIcon />, desc: "Internal Team Communication" },
        { id: 'website', label: 'Website', icon: <WebsiteIcon />, desc: "Site Builder & CMS" },
        { id: 'ecommerce', label: 'E-Commerce', icon: <EcommerceIcon />, desc: "Online Store Management" },
        { id: 'forum', label: 'Forum', icon: <ForumIcon />, desc: "Community Engagement" },
        { id: 'lms', label: 'LMS', icon: <LMSIcon />, desc: "Learning Management System" },
        { id: 'analytics', label: 'Analytics', icon: <AnalyticsIcon />, desc: "Business Intelligence" },
        { id: 'support', label: 'Help Desk', icon: <SupportIcon />, desc: "Tickets & Customer Service" },
        { id: 'reports', label: 'Reports', icon: <ReportsIcon />, desc: "System-wide Reporting" },
        { id: 'management', label: 'Management', icon: <ManagementIcon />, desc: "Project Management" },
        { id: 'dashboard', label: 'Dashboard', icon: <DashboardIcon />, desc: "KPIs & Statistics" },
        { id: 'sys_app', label: 'Systemize App', icon: <SystemizeAppIcon />, desc: "Core OS Features" },
        { id: 'settings', label: 'System Settings', icon: <SettingsIcon />, desc: "Configuration & Users" },
    ];

    const MODULE_NAV_DATA = {
        'scm': [
            {
                title: "Procurement & Sourcing",
                items: ["Supplier Selection", "RFQ / RFP Management", "Purchase Orders", "Contract Management", "Vendor Evaluation", "Cost Analysis"]
            },
            {
                title: "Logistics & Transportation",
                items: ["Inbound Logistics", "Outbound Logistics", "Fleet Management", "Route Optimization", "Shipment Tracking", "Freight Management"]
            },
            {
                title: "Warehousing & Inventory",
                items: ["Warehouse Operations", "Stock Receiving", "Put-away", "Picking & Packing", "Cycle Counting", "Inventory Reconciliation", "Safety Stock Management"]
            },
            {
                title: "Production Planning",
                items: ["MRP (Material Requirements)", "Production Scheduling", "Capacity Planning", "BOM (Bill of Materials)", "Work Orders", "Product Lifecycle Mgmt"]
            },
            {
                title: "Demand Planning",
                items: ["Market Demand Analysis", "Statistical Forecasting", "Sales Forecast Integration", "Supply vs Demand Balancing", "Seasonal Trend Analysis"]
            },
            {
                title: "Supplier Management",
                items: ["Supplier Registration", "Supplier Risk Assessment", "Supplier Scorecards", "Performance Monitoring", "Compliance & Audits"]
            },
            {
                title: "Order Management",
                items: ["Order Creation", "Order Tracking", "Order Fulfillment", "Backorder Management", "Customer Communication"]
            },
            {
                title: "Supply Chain Analytics",
                items: ["KPI Dashboard", "Cost Optimization", "Lead Time Analysis", "Supply Chain Modeling", "Risk Prediction"]
            },
            {
                title: "Returns & Reverse Logistics",
                items: ["Return Requests", "Return Authorization", "Repair Processing", "Refurbishment", "Waste & Recycling Handling"]
            }
        ]
    };

    /* ========================================
    8. القائمة الجانبية (SideMenu) - [معدلة للتاريخ]
    ========================================
    */
    const SideMenu = () => {
        // نستخدم navigateTo بدلاً من setPage
        const { sidebarOpen, toggleSidebar, activePage, navigateTo, notify } = useContext(AppContext);
        const menuItems = [
            { id: 'home', label: 'Home', icon: 'home' },
            { id: 'dashboard', label: 'Dashboard', icon: 'layout-grid' },
            { id: 'apps', label: 'All Apps', icon: 'box' },
            { id: 'shipping', label: 'Shipping', icon: 'truck' },
            { id: 'scm', label: 'SCM', icon: 'link' },
            { id: 'operation', label: 'Operation', icon: 'layers' },
            { id: 'accounting', label: 'Accounting', icon: 'banknote' },
            { id: 'hr', label: 'Human Resources', icon: 'users' },
            { id: 'sales', label: 'Sales', icon: 'shopping-bag' },
            { id: 'crm', label: 'CRM', icon: 'heart-handshake' },
            { id: 'website', label: 'Website', icon: 'globe' },
            { id: 'reports', label: 'Reports', icon: 'file-text' },
            { id: 'settings', label: 'System Settings', icon: 'settings' },
        ];

        return (
            <>
                <aside className={`fixed top-28 bottom-6 left-6 z-sidebar bg-cardWhite dark:bg-darkCard rounded-3xl border border-white/40 dark:border-gray-800 shadow-float sidebar-transition flex flex-col py-6 transition-transform duration-300 ease-in-out w-72 px-5 ${sidebarOpen ? 'translate-x-0' : '-translate-x-[150%]'}`}>
                    <div className="w-full mb-8">
                        <button onClick={() => { toggleSidebar(); }} className="w-full flex items-center gap-3 px-3 py-3.5 rounded-2xl transition-all duration-300 bg-bgBody dark:bg-darkBgBody">
                            <Icon name="menu" size={20} className="text-accentPrimary" />
                            <span className="font-bold text-xs tracking-widest uppercase transition-opacity duration-300 overflow-hidden whitespace-nowrap w-auto opacity-100">Menu</span>
                            <Icon name="chevron-left" size={14} className="ml-auto text-gray-400" />
                        </button>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scroll px-1 space-y-2 w-full">
                        {menuItems.map(item => (
                            // تم استخدام navigateTo هنا
                            <button key={item.id} onClick={() => navigateTo(item.id)} className={`relative group flex items-center gap-4 w-full p-3.5 rounded-2xl transition-all duration-200 ${activePage === item.id ? 'bg-accentPrimary text-white shadow-lg shadow-purple-900/20' : 'text-textSecondary dark:text-darkTextSecondary hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-textPrimary dark:hover:text-white'}`}>
                                <Icon name={item.icon} size={20} className="shrink-0" />
                                <span className="whitespace-nowrap font-medium text-sm transition-opacity duration-300 overflow-hidden w-auto opacity-100">{item.label}</span>
                            </button>
                        ))}
                    </div>
                    <div className="mt-auto pt-4 border-t border-gray-100 dark:border-gray-800 w-full">
                        <button onClick={() => notify('info', 'Help', 'Connecting...')} className="flex items-center gap-3 w-full p-2 rounded-xl text-xs font-medium text-textSecondary dark:text-darkTextSecondary hover:text-accentPrimary transition-colors">
                            <Icon name="help-circle" size={20} />
                            <span className="font-mono">Support</span>
                        </button>
                    </div>
                </aside>
                {sidebarOpen && <div className="fixed inset-0 z-[75] bg-black/20 backdrop-blur-sm" onClick={toggleSidebar}></div>}
            </>
        );
    };

   /* ========================================
    9. الشريط الفرعي (ModuleSubHeader) - [معدل: استغلال كامل للمساحة]
    ========================================
    */
    const ModuleSubHeader = () => {
        const { activePage, notify, sidebarOpen, showSubHeader } = useContext(AppContext);
        const [activeDropdown, setActiveDropdown] = useState(null);
        const [dropdownStyle, setDropdownStyle] = useState({});

        useEffect(() => {
            const handleClick = () => setActiveDropdown(null);
            if(activeDropdown !== null) window.addEventListener('click', handleClick);
            return () => window.removeEventListener('click', handleClick);
        }, [activeDropdown]);

        const basePage = activePage.split('_')[0];
        const navData = MODULE_NAV_DATA[basePage];
        
        if (!navData) return null;

        const handleCategoryClick = (e, index) => {
            e.stopPropagation();
            if (activeDropdown === index) {
                setActiveDropdown(null);
            } else {
                const rect = e.currentTarget.getBoundingClientRect();
                setDropdownStyle({ 
                    top: rect.bottom + 8,
                    left: rect.left,
                    minWidth: Math.max(rect.width + 40, 200)
                });
                setActiveDropdown(index);
            }
        };

        return (
            <>
                {/* --- التعديل هنا --- 
                    تم ضبط left ليبدأ مباشرة بعد القائمة الجانبية لتقليل الفراغ:
                    - القائمة مفتوحة: left-[288px] (عرض القائمة بالضبط w-72)
                    - القائمة مغلقة: left-[80px] (عرض القائمة المصغرة w-20)
                */}
                <div className={`fixed h-12 bg-cardWhite/90 dark:bg-darkCard/90 backdrop-blur-md rounded-b-3xl border-x border-b border-white/40 dark:border-gray-800 shadow-sm flex items-center px-4 transition-all duration-500 cubic-bezier(0.4, 0, 0.2, 1) z-subheader 
                    ${sidebarOpen ? 'left-[288px]' : 'left-[80px]'} 
                    right-4
                    ${showSubHeader ? 'top-20 opacity-100 translate-y-0' : 'top-0 opacity-0 -translate-y-full pointer-events-none'}
                `}>
                    
                    <div className="flex items-center justify-between w-full h-full overflow-x-auto custom-scroll px-1 gap-2">
                        {navData.map((category, index) => (
                            <button 
                                key={index} 
                                onClick={(e) => handleCategoryClick(e, index)}
                                className={`shrink-0 px-3 py-1.5 rounded-lg text-sm font-semibold flex items-center gap-2 transition-all whitespace-nowrap hover:bg-gray-100 dark:hover:bg-gray-700 ${activeDropdown === index ? 'bg-gray-100 dark:bg-gray-700 text-accentPrimary' : 'text-textSecondary dark:text-darkTextSecondary'}`}
                            >
                                {category.title}
                                <Icon name="chevron-down" size={14} className={`transition-transform duration-200 ${activeDropdown === index ? 'rotate-180' : ''}`} />
                            </button>
                        ))}
                    </div>
                </div>

                {activeDropdown !== null && navData[activeDropdown] && (
                    <div 
                        className="fixed bg-white dark:bg-darkCard border border-gray-100 dark:border-gray-700 rounded-xl shadow-xl p-2 dropdown-animate z-dropdown max-h-[60vh] overflow-y-auto custom-scroll"
                        style={dropdownStyle}
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="flex flex-col gap-1">
                            {navData[activeDropdown].items.map((item, idx) => (
                                <button 
                                    key={idx} 
                                    onClick={() => {
                                        notify('info', item, 'Opening section...');
                                        setActiveDropdown(null);
                                    }}
                                    className="text-left px-3 py-2 text-sm text-textPrimary dark:text-white hover:bg-bgBody dark:hover:bg-gray-800 rounded-lg transition-colors font-medium flex items-center justify-between group whitespace-nowrap"
                                >
                                    {item}
                                    <Icon name="arrow-right" size={12} className="opacity-0 group-hover:opacity-100 transition-opacity text-accentPrimary ml-3" />
                                </button>
                            ))}
                        </div>
                    </div>
                )}
            </>
        );
    };

    /* ========================================
    UI Helper Components (Popovers, Island)
    مكونات الواجهة المساعدة
    ========================================
    */
    const DynamicIsland = () => { const { islandState } = useContext(AppContext); const { active, type, message, sub } = islandState; let iconName = "check-circle-2", iconColor = "text-green-400"; if (type === 'error') { iconName = "alert-circle"; iconColor = "text-red-500"; } if (type === 'info') { iconName = "info"; iconColor = "text-blue-400"; } if (type === 'loading') { iconName = "loader-2"; iconColor = "text-yellow-400 animate-spin"; } return ( <div className="island-container"> <div className={`dynamic-island ${active ? 'active' : ''}`}> <div className="island-content"> <div className={`w-6 h-6 rounded-full bg-white/10 flex items-center justify-center shrink-0 ${iconColor}`}><Icon name={iconName} size={16} strokeWidth={2.5} /></div> <div className="flex flex-col justify-center leading-none pr-2"> <span className="text-[13px] font-bold tracking-wide text-white">{message}</span> {sub && <span className="text-[10px] text-gray-400 mt-0.5 font-medium">{sub}</span>} </div> </div> </div> </div> ); };
    const ClockPopover = () => { const [time, setTime] = useState(new Date()); useEffect(() => { const t = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(t); }, []); const greeting = time.getHours() < 12 ? 'Good Morning' : time.getHours() < 18 ? 'Good Afternoon' : 'Good Evening'; return ( <div className="absolute top-24 right-96 w-72 bg-white dark:bg-darkCard rounded-3xl shadow-2xl border border-gray-100 dark:border-gray-700 p-6 animate-[fadeIn_0.2s_ease-out] z-popover"> <div className="flex flex-col items-center justify-center text-center space-y-2"> <span className="text-xs font-bold text-accentPrimary tracking-widest uppercase mb-2">{greeting}</span> <div className="text-5xl font-mono font-bold text-gray-800 dark:text-white tracking-tighter">{time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })}</div> <div className="text-sm font-medium text-gray-500 dark:text-gray-400 mt-1">{new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }).format(time)}</div> </div> </div> ); };
    const TasksPopover = () => { const tasks = [{ id: 1, title: "Review Q3 Reports", time: "10:30 AM", tag: "High", done: false }, { id: 2, title: "HR Meeting", time: "01:00 PM", tag: "Med", done: true }, { id: 3, title: "Server Security", time: "03:15 PM", tag: "High", done: false }]; return ( <div className="absolute top-24 right-56 w-80 bg-white dark:bg-darkCard rounded-3xl shadow-2xl border border-gray-100 dark:border-gray-700 p-0 overflow-hidden animate-[fadeIn_0.2s_ease-out] z-popover"> <div className="bg-gradient-to-r from-green-400 to-teal-500 p-4 text-white flex justify-between items-center"><h3 className="font-bold text-lg">My Tasks</h3><span className="bg-white/20 px-2 py-1 rounded-lg text-xs font-mono">2 Pending</span></div> <div className="p-2 max-h-80 overflow-y-auto custom-scroll"> {tasks.map(task => ( <div key={task.id} className={`flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-white/5 rounded-xl transition-colors cursor-pointer`}> <div className={`w-5 h-5 rounded-md border-2 flex items-center justify-center ${task.done ? 'bg-green-500 border-green-500' : 'border-gray-300 dark:border-gray-500'}`}>{task.done && <Icon name="check" size={12} className="text-white" />}</div> <div className="flex-1"><p className="text-sm font-medium dark:text-gray-200">{task.title}</p><p className="text-[10px] text-gray-400 font-mono mt-0.5">{task.time}</p></div> </div> ))} </div> </div> ); };
    const CalendarPopover = () => { const today = new Date(); return ( <div className="absolute top-24 right-40 w-80 bg-white dark:bg-darkCard rounded-3xl shadow-2xl border border-gray-100 dark:border-gray-700 p-6 animate-[fadeIn_0.2s_ease-out] z-popover"> <div className="text-center"><h3 className="text-lg font-bold mb-4 dark:text-white">Calendar</h3><div className="grid grid-cols-7 gap-2 text-center text-sm">{[...Array(30)].map((_, i) => (<div key={i} className={`h-8 w-8 flex items-center justify-center rounded-full ${i+1 === today.getDate() ? 'bg-blue-500 text-white shadow-lg' : 'hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-300'}`}>{i + 1}</div>))}</div></div> </div> ); };
    
   /* ========================================
    11. الهيدر العلوي (TopHeader) - [مضاف إليه زر إخفاء الشريط]
    ========================================
    */
    const TopHeader = () => { 
        // استدعاء showSubHeader و toggleSubHeader
        const { darkMode, setDarkMode, notify, navigateTo, toggleSidebar, goBack, goForward, canGoBack, canGoForward, showSubHeader, toggleSubHeader, activePage } = useContext(AppContext); 
        
        const [time, setTime] = useState(new Date()); 
        const [showCalendar, setShowCalendar] = useState(false); 
        const [showTasks, setShowTasks] = useState(false); 
        const [showClock, setShowClock] = useState(false);
        const [showProfile, setShowProfile] = useState(false); 
        const [userStatus, setUserStatus] = useState('online'); 
        const [isRefreshing, setIsRefreshing] = useState(false); 

        // التحقق مما إذا كانت الصفحة الحالية تدعم الشريط الثانوي أصلاً
        const basePage = activePage.split('_')[0];
        const hasSubNav = MODULE_NAV_DATA[basePage];

        useEffect(() => { const t = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(t); }, []); 
        
        const togglePopover = (setter, name) => { 
            const isOpening = !eval("show" + name); 
            setShowCalendar(false); setShowTasks(false); setShowClock(false); setShowProfile(false); 
            setter(prev => { if(!prev) notify('info', name, 'Expanded'); return !prev; }); 
        };

        const handleStatusChange = (status) => { setUserStatus(status); notify('success', 'Status Updated', `You are now ${status}`); setShowProfile(false); };
        const statusColors = { online: 'bg-green-500', away: 'bg-yellow-500', dnd: 'bg-red-500', offline: 'bg-gray-400' };

        const handleRefresh = () => {
            if (isRefreshing) return;
            setIsRefreshing(true);
            notify('loading', 'System', 'Syncing Data...');
            setTimeout(() => { setIsRefreshing(false); notify('success', 'System', 'Data Updated'); }, 1500); 
        };

        return ( 
            <> 
            <header className="fixed top-0 left-0 right-0 h-20 bg-cardWhite/90 dark:bg-darkCard/90 backdrop-blur-md z-header flex items-center justify-between shadow-float border-b border-white/40 dark:border-white/5 transition-all duration-300">
                <div className="flex items-center gap-4 pl-3">
                    <div className="flex items-center gap-2 mr-1">
                        <button aria-label="Toggle sidebar" onClick={() => { toggleSidebar(); notify('info', 'Sidebar', 'Toggled'); }} className="w-9 h-9 rounded-lg flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-800 transition-all">
                            <Icon name="menu" size={16} />
                        </button>
                        
                        <button aria-label="Go Back" onClick={goBack} disabled={!canGoBack} className={`w-9 h-9 rounded-lg flex items-center justify-center transition-all ${canGoBack ? 'hover:bg-gray-100 dark:hover:bg-gray-800 text-textPrimary dark:text-white cursor-pointer' : 'opacity-30 cursor-not-allowed text-gray-400'}`}>
                            <Icon name="chevron-left" size={16} />
                        </button>

                        <button aria-label="Go Forward" onClick={goForward} disabled={!canGoForward} className={`w-9 h-9 rounded-lg flex items-center justify-center transition-all ${canGoForward ? 'hover:bg-gray-100 dark:hover:bg-gray-800 text-textPrimary dark:text-white cursor-pointer' : 'opacity-30 cursor-not-allowed text-gray-400'}`}>
                            <Icon name="chevron-right" size={16} />
                        </button>

                        <button aria-label="Refresh System" onClick={handleRefresh} className="w-9 h-9 rounded-lg flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-800 transition-all text-textPrimary dark:text-white group">
                            <Icon name="rotate-cw" size={15} className={`transition-all duration-700 ${isRefreshing ? 'animate-spin text-accentPrimary' : 'group-hover:rotate-180'}`} />
                        </button>

                        {/* --- زر التحكم في الشريط الثانوي (جديد) --- */}
                        {/* يظهر فقط إذا كانت الصفحة تحتوي على قوائم فرعية */}
                        {hasSubNav && (
                            <button 
                                aria-label="Toggle Subheader" 
                                onClick={toggleSubHeader} 
                                className={`w-9 h-9 rounded-lg flex items-center justify-center transition-all ${showSubHeader ? 'bg-accentPrimary text-white shadow-glow' : 'hover:bg-gray-100 dark:hover:bg-gray-800 text-textSecondary'}`}
                            >
                                <Icon name="layout-list" size={16} />
                            </button>
                        )}
                    </div>

                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-xl bg-accentPrimary flex items-center justify-center text-white shadow-glow"><Icon name="hexagon" size={22} fill={true} /></div>
                        <span className="font-bold text-2xl tracking-tight text-textPrimary dark:text-white hidden md:block">Systemize</span>
                    </div>

                    <div className="hidden md:flex bg-bgBody dark:bg-darkBgBody w-[280px] h-10 rounded-xl items-center px-4 gap-3 border border-transparent focus-within:border-accentPrimary transition-all ml-4">
                        <Icon name="search" size={16} className="text-textSecondary" />
                        <input type="text" placeholder="Search..." className="bg-transparent border-none outline-none text-xs w-full placeholder-gray-400 dark:text-white font-mono" />
                    </div>
                </div>

                <div className="flex items-center gap-5 pr-3">
                    <div className="relative"><button onClick={() => { navigateTo('home'); notify('success', 'Home', 'Navigated'); }} className="w-14 h-14 rounded-2xl bg-white dark:bg-gray-800 shadow-soft border border-gray-100 dark:border-gray-700 flex items-center justify-center hover:scale-105 transition-transform group"><Icon name="home" size={24} style={{ stroke: "url(#homeGradient)" }} strokeWidth={2.5} /></button></div>
                    <div className="relative"><button onClick={() => togglePopover(setShowClock, 'Clock')} className="w-14 h-14 rounded-2xl bg-white dark:bg-gray-800 shadow-soft border border-gray-100 dark:border-gray-700 flex items-center justify-center hover:scale-105 transition-transform group"><div className="relative w-8 h-8 rounded-full border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"><div className="absolute top-1/2 left-1/2 w-2.5 h-0.5 bg-black dark:bg-white origin-left -translate-y-1/2 rotate-45 rounded-full"></div><div className="absolute top-1/2 left-1/2 w-3.5 h-0.5 bg-black dark:bg-white origin-left -translate-y-1/2 -rotate-90 rounded-full"></div><div className="absolute top-1/2 left-1/2 w-3.5 h-[1px] bg-red-500 origin-left -translate-y-1/2 rotate-[200deg]"></div><div className="absolute top-1/2 left-1/2 w-1 h-1 bg-black dark:bg-white rounded-full -translate-x-1/2 -translate-y-1/2"></div></div></button></div>
                    <div className="relative"><button onClick={() => { notify('loading', 'System', 'Opening Tab...'); setTimeout(() => window.open(window.location.href, '_blank'), 500); }} className="w-14 h-14 rounded-2xl bg-white dark:bg-gray-800 shadow-soft border border-gray-100 dark:border-gray-700 flex items-center justify-center hover:scale-105 transition-transform group"><Icon name="plus" size={28} className="text-blue-500" strokeWidth={3} /></button></div>
                    <div className="relative"><button onClick={() => togglePopover(setShowTasks, 'Tasks')} className="w-14 h-14 rounded-2xl aurora-green-bg shadow-aurora flex items-center justify-center cursor-pointer hover:scale-105 transition-transform group"><div className="bg-white/20 p-2 rounded-xl backdrop-blur-sm"><Icon name="check-square" size={24} className="text-white drop-shadow-sm" strokeWidth={2.5} /></div></button></div>
                    <div className="relative"><button onClick={() => togglePopover(setShowCalendar, 'Calendar')} className="w-14 h-14 rounded-2xl aurora-cal-bg shadow-aurora flex flex-col items-center justify-center cursor-pointer hover:scale-105 transition-transform"><span className="text-[9px] font-medium text-slate-700 tracking-wide">{time.toLocaleString('default', { month: 'short' })}</span><span className="text-xl font-bold text-white drop-shadow-sm leading-none mt-0.5">{time.getDate()}</span></button></div>
                    <button onClick={() => { setDarkMode(!darkMode); notify('success', 'Theme', 'Updated'); }} className="bg-gray-200 dark:bg-gray-700 w-14 h-8 rounded-full p-1 flex items-center transition-colors shadow-inner-sm"><div className={`w-6 h-6 rounded-full bg-white shadow-sm flex items-center justify-center text-yellow-500 transition-transform duration-300 ${darkMode ? 'translate-x-6' : 'translate-x-0'}`}><Icon name={darkMode ? "moon" : "sun"} size={14} fill={true} /></div></button>
                    
                    <div className="relative">
                        <div onClick={() => togglePopover(setShowProfile, 'Profile')} className="p-[3px] rounded-full bg-gradient-to-b from-purple-400 to-purple-800 cursor-pointer hover:scale-105 transition-transform relative">
                            <img src="https://images.unsplash.com/photo-1560250097-0b93528c311a?auto=format&fit=crop&w=100&q=80" className="w-10 h-10 rounded-full object-cover border-2 border-white dark:border-darkBgBody" />
                            <div className={`absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-darkBgBody ${statusColors[userStatus]}`}></div>
                        </div>
                        {showProfile && (
                            <div className="absolute top-16 right-0 w-64 bg-white dark:bg-darkCard rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-700 p-2 dropdown-animate z-popover">
                                <div className="p-3 border-b border-gray-100 dark:border-gray-700 mb-2">
                                    <p className="font-bold text-textPrimary dark:text-white">Ahmed Admin</p>
                                    <div className="flex items-center gap-2 mt-1 cursor-pointer group">
                                        <Icon name="building-2" size={12} className="text-gray-400" />
                                        <span className="text-xs text-textSecondary dark:text-darkTextSecondary group-hover:text-accentPrimary">Systemize Inc.</span>
                                        <Icon name="check" size={12} className="text-accentPrimary ml-auto" />
                                    </div>
                                    <div className="flex items-center gap-2 mt-2 cursor-pointer group hover:bg-gray-50 dark:hover:bg-gray-800 p-1 rounded-lg">
                                        <div className="w-3"></div>
                                        <span className="text-xs text-textSecondary dark:text-darkTextSecondary">My US Company</span>
                                    </div>
                                </div>
                                <div className="space-y-1 mb-2">
                                    <button onClick={() => handleStatusChange('online')} className="w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors text-sm text-textPrimary dark:text-white"><div className="w-2.5 h-2.5 rounded-full bg-green-500 shadow-sm"></div><span>Online</span>{userStatus === 'online' && <Icon name="check" size={14} className="ml-auto text-green-500" />}</button>
                                    <button onClick={() => handleStatusChange('away')} className="w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors text-sm text-textPrimary dark:text-white"><div className="w-2.5 h-2.5 rounded-full bg-yellow-500 shadow-sm"></div><span>Away</span>{userStatus === 'away' && <Icon name="check" size={14} className="ml-auto text-yellow-500" />}</button>
                                    <button onClick={() => handleStatusChange('dnd')} className="w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors text-sm text-textPrimary dark:text-white"><div className="w-2.5 h-2.5 rounded-full bg-red-500 shadow-sm"></div><span>Do Not Disturb</span>{userStatus === 'dnd' && <Icon name="check" size={14} className="ml-auto text-red-500" />}</button>
                                </div>
                                <div className="border-t border-gray-100 dark:border-gray-700 my-1"></div>
                                <div className="space-y-1">
                                    <button onClick={() => notify('info', 'Docs', 'Opening Documentation...')} className="w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors text-sm text-textSecondary dark:text-darkTextSecondary"><Icon name="book-open" size={16} /><span>Documentation</span></button>
                                    <button onClick={() => notify('info', 'Preferences', 'Opening Settings...')} className="w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors text-sm text-textSecondary dark:text-darkTextSecondary"><Icon name="settings" size={16} /><span>My Preferences</span></button>
                                    <button onClick={() => notify('error', 'Auth', 'Logging out...')} className="w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-sm text-red-500"><Icon name="log-out" size={16} /><span>Log out</span></button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </header> 

            {(showCalendar || showTasks || showClock || showProfile) && <div className="fixed inset-0 z-[105]" onClick={() => { setShowCalendar(false); setShowTasks(false); setShowClock(false); setShowProfile(false); }}></div>}
            {showClock && <ClockPopover />}
            {showCalendar && <CalendarPopover />}
            {showTasks && <TasksPopover />}
            </> 
        ); 
    };

    /* ========================================
    12. محتوى الصفحات (Page Contents) - [النسخة النهائية مع navigateTo]
    ========================================
    */
    
    // صفحة البداية (Home)
    const HomeContent = () => {
        const { navigateTo, notify } = useContext(AppContext); // استخدام navigateTo بدلاً من setPage
        return (
            <div className="max-w-7xl mx-auto animate-[fadeIn_0.5s_ease-out] py-10 px-4">
                <div className="mb-10 text-center">
                    <h1 className="text-4xl font-bold text-textPrimary dark:text-white mb-3">Systemize OS</h1>
                    <p className="text-lg text-textSecondary dark:text-darkTextSecondary">Centralized Enterprise Management</p>
                </div>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-8 justify-items-center">
                    {MASTER_APPS_DATA.map(app => (
                        <button key={app.id} onClick={() => { navigateTo(app.id); notify('info', app.label, 'Opening Module...'); }} className="group flex flex-col items-center gap-4 w-32 transition-transform duration-300 hover:-translate-y-1">
                            <div className="w-20 h-20 flex items-center justify-center transform group-hover:scale-110 transition-transform duration-300">
                                {app.icon}
                            </div>
                            <span className="font-medium text-sm text-textPrimary dark:text-white text-center group-hover:text-accentPrimary transition-colors">
                                {app.label}
                            </span>
                        </button>
                    ))}
                </div>
            </div>
        );
    };

    // صفحة قائمة التطبيقات (Apps List)
    const AppsListContent = () => {
        const { notify, navigateTo } = useContext(AppContext); // استخدام navigateTo
        const sortedApps = [...MASTER_APPS_DATA].sort((a, b) => a.label.localeCompare(b.label));
        return (
            <div className="max-w-full animate-[fadeIn_0.5s_ease-out] py-8 pl-2">
                 <div className="mb-8 border-b border-gray-200 dark:border-gray-800 pb-4 max-w-4xl">
                    <h1 className="text-3xl font-bold text-textPrimary dark:text-white">All Applications</h1>
                    <p className="text-textSecondary dark:text-darkTextSecondary mt-1">Detailed list of integrated modules.</p>
                </div>
                <div className="flex flex-col gap-4 max-w-4xl">
                    {sortedApps.map(app => (
                        <button key={app.id} onClick={() => { navigateTo(app.id); notify('info', app.label, 'Opening...'); }} className="group flex items-center gap-6 p-3 bg-transparent hover:bg-cardWhite dark:hover:bg-darkCard rounded-2xl transition-all duration-200 border border-transparent hover:border-gray-100 dark:hover:border-gray-800 hover:shadow-sm text-left w-full">
                            <div className="shrink-0 transform group-hover:scale-110 transition-transform duration-300 scale-75">
                                {app.icon}
                            </div>
                            <div className="flex-1">
                                <h3 className="text-lg font-semibold text-textPrimary dark:text-white">{app.label}</h3>
                                <p className="text-xs text-textSecondary dark:text-darkTextSecondary mt-0.5">{app.desc}</p>
                            </div>
                            <Icon name="chevron-right" size={20} className="text-gray-300 dark:text-gray-600 group-hover:text-accentPrimary opacity-0 group-hover:opacity-100 transition-all" />
                        </button>
                    ))}
                </div>
            </div>
        );
    };

    // صفحة لوحة القيادة (Dashboard)
    const DashboardContent = () => { 
        const { notify } = useContext(AppContext); 
        return ( 
            <div className="max-w-7xl mx-auto animate-[fadeIn_0.5s_ease-out]"> 
                <div className="mb-8 flex items-center gap-2 text-sm text-textSecondary dark:text-darkTextSecondary font-mono"><span>Systemize</span><Icon name="chevron-right" size={14} /><span className="text-accentPrimary font-bold">Analytics</span></div> 
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"> 
                    {[{ title: "Total Revenue", val: "$128,430", change: "+12%" }, { title: "Active Users", val: "2,543", change: "+5%" }, { title: "New Orders", val: "432", change: "+18%" }, { title: "Pending Issues", val: "12", change: "-2%" }].map((stat, i) => ( 
                        <div key={i} onClick={() => notify('info', stat.title, 'Details loaded')} className="bg-cardWhite dark:bg-darkCard p-6 rounded-3xl shadow-soft hover:-translate-y-1 transition-transform duration-300 border border-transparent dark:border-gray-800 cursor-pointer"> 
                            <h3 className="text-2xl font-bold mb-1 font-mono tracking-tight">{stat.val}</h3> 
                            <p className="text-sm text-textSecondary dark:text-darkTextSecondary">{stat.title}</p> 
                        </div> 
                    ))} 
                </div> 
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-cardWhite dark:bg-darkCard h-64 rounded-3xl shadow-soft flex items-center justify-center border border-transparent dark:border-gray-800">
                        <span className="text-textSecondary text-sm font-mono">Revenue Chart Placeholder</span>
                    </div>
                    <div className="bg-cardWhite dark:bg-darkCard h-64 rounded-3xl shadow-soft flex items-center justify-center border border-transparent dark:border-gray-800">
                        <span className="text-textSecondary text-sm font-mono">Traffic Source Placeholder</span>
                    </div>
                </div>
            </div> 
        ); 
    };

   // صفحة الشحن (Shipping Page) - [نظيفة وبدون زر رجوع خاص]
    const ShippingContent = () => {
        const { notify, navigateTo, activePage } = useContext(AppContext);
        
        const parts = activePage.split('_');
        const currentModule = parts[0];
        const selectedType = parts[1]; 
        const selectedMethod = parts[2];

        let step = 1;
        if (selectedType) step = 2;
        if (selectedMethod) step = 3;

        const handleTypeSelect = (type) => {
            navigateTo(`shipping_${type}`); 
            notify('success', type === 'local' ? 'Domestic' : 'International', 'Selected');
        };

        const handleMethodSelect = (method) => {
            navigateTo(`shipping_${selectedType}_${method.replace(/ /g, '')}`);
            notify('success', method, 'Processing request...');
        };

        return (
            <div className="max-w-5xl ml-4 md:ml-12 animate-[fadeIn_0.5s_ease-out] py-10 px-4">
                <div className="mb-16 flex items-center relative">
                    {/* تمت إزالة زر الرجوع اليدوي من هنا لأنه أصبح أوتوماتيكياً في MainLayout */}
                    <div className="text-left">
                        <h1 className="text-4xl font-bold text-textPrimary dark:text-white mb-2">
                            {step === 1 ? 'Shipping Type' : step === 2 ? 'Shipping Method' : 'Order Details'}
                        </h1>
                        <p className="text-lg text-textSecondary dark:text-darkTextSecondary font-sans">
                            {step === 1 ? 'Select delivery scope' : 
                             step === 2 ? `Select mode for ${selectedType === 'local' ? 'Domestic' : 'International'}` :
                             `Finalizing ${selectedMethod} for ${selectedType}`}
                        </p>
                    </div>
                </div>

                {step === 1 && (
                    <div className="flex flex-wrap justify-start gap-20 mt-12 pl-4">
                        <button onClick={() => handleTypeSelect('local')} className="group flex flex-col items-center gap-6 transition-transform duration-300 hover:-translate-y-2">
                            <div className="w-32 h-32 flex items-center justify-center transform group-hover:scale-110 transition-transform duration-300">
                                <DomesticIcon />
                            </div>
                            <span className="text-2xl font-bold text-textPrimary dark:text-white group-hover:text-green-500 transition-colors">Domestic</span>
                        </button>

                        <button onClick={() => handleTypeSelect('intl')} className="group flex flex-col items-center gap-6 transition-transform duration-300 hover:-translate-y-2">
                            <div className="w-32 h-32 flex items-center justify-center transform group-hover:scale-110 transition-transform duration-300">
                                <InternationalIcon />
                            </div>
                            <span className="text-2xl font-bold text-textPrimary dark:text-white group-hover:text-blue-500 transition-colors">International</span>
                        </button>
                    </div>
                )}

                {step === 2 && (
                    <div className="grid grid-cols-3 gap-16 justify-items-start mt-16 max-w-3xl pl-4">
                        <button onClick={() => handleMethodSelect('Sea Freight')} className="group flex flex-col items-center gap-4 w-40 transition-transform duration-300 hover:-translate-y-1">
                            <div className="w-24 h-24 flex items-center justify-center transform group-hover:scale-110 transition-transform duration-300">
                                <SeaIcon />
                            </div>
                            <div className="text-center">
                                <span className="block text-xl font-bold text-textPrimary dark:text-white group-hover:text-cyan-400 transition-colors">Sea Freight</span>
                                <span className="text-sm text-textSecondary dark:text-darkTextSecondary font-sans">Ocean Transport</span>
                            </div>
                        </button>

                        <button onClick={() => handleMethodSelect('Air Freight')} className="group flex flex-col items-center gap-4 w-40 transition-transform duration-300 hover:-translate-y-1">
                            <div className="w-24 h-24 flex items-center justify-center transform group-hover:scale-110 transition-transform duration-300">
                                <AirIcon />
                            </div>
                            <div className="text-center">
                                <span className="block text-xl font-bold text-textPrimary dark:text-white group-hover:text-purple-400 transition-colors">Air Freight</span>
                                <span className="text-sm text-textSecondary dark:text-darkTextSecondary font-sans">Express Delivery</span>
                            </div>
                        </button>

                        <button onClick={() => handleMethodSelect('Land Freight')} className="group flex flex-col items-center gap-4 w-40 transition-transform duration-300 hover:-translate-y-1">
                            <div className="w-24 h-24 flex items-center justify-center transform group-hover:scale-110 transition-transform duration-300">
                                <LandIcon />
                            </div>
                            <div className="text-center">
                                <span className="block text-xl font-bold text-textPrimary dark:text-white group-hover:text-yellow-400 transition-colors">Land Freight</span>
                                <span className="text-sm text-textSecondary dark:text-darkTextSecondary font-sans">Truck Transport</span>
                            </div>
                        </button>
                    </div>
                )}
                
                {step === 3 && (
                    <div className="mt-12 p-8 bg-cardWhite dark:bg-darkCard rounded-3xl shadow-soft border border-gray-100 dark:border-gray-800 animate-fade-in">
                        <h2 className="text-2xl font-bold mb-4 text-green-500">Selection Complete!</h2>
                        <div className="space-y-2 text-textPrimary dark:text-white">
                            <p>Type: <span className="font-mono font-bold uppercase">{selectedType}</span></p>
                            <p>Method: <span className="font-mono font-bold uppercase">{selectedMethod}</span></p>
                        </div>
                    </div>
                )}
            </div>
        );
    };

     /* ========================================
    13. المخطط الرئيسي (Main Layout) - [يحتوي على زر الرجوع العام]
    ========================================
    */
    const MainLayout = () => {
        // نستدعي goBack هنا لربط الزر بنفس وظيفة الهيدر
        const { sidebarOpen, activePage, goBack } = useContext(AppContext);
        
        const basePage = activePage.split('_')[0];
        const hasSubNav = MODULE_NAV_DATA[basePage]; 
        
        return (
            <main className={`flex-1 h-full flex flex-col bg-bgBody dark:bg-darkBgBody transition-all duration-300 ease-in-out relative ${hasSubNav ? 'pt-40' : 'pt-24'} ${sidebarOpen ? 'ml-0 md:ml-0' : 'ml-0'}`}>
                <div className="flex-1 overflow-y-auto custom-scroll px-6 pb-6">
                    
                    {/* --- زر الرجوع العام (Global Back Button) --- */}
                    {/* يظهر في أي صفحة غير الصفحة الرئيسية */}
                    {activePage !== 'home' && (
                        <div className="mb-6 animate-[fadeIn_0.3s_ease-out]">
                            <button 
                                onClick={goBack} 
                                className="group flex items-center gap-3 transition-transform active:scale-95"
                            >
                                <div className="w-12 h-12 rounded-full bg-white dark:bg-darkCard shadow-soft border border-gray-100 dark:border-gray-700 flex items-center justify-center text-textSecondary dark:text-darkTextSecondary group-hover:text-accentPrimary group-hover:border-accentPrimary/30 transition-all duration-300">
                                    <Icon name="arrow-left" size={24} strokeWidth={2.5} />
                                </div>
                                <span className="text-sm font-bold text-textSecondary dark:text-darkTextSecondary group-hover:text-accentPrimary transition-colors opacity-0 group-hover:opacity-100 -translate-x-2 group-hover:translate-x-0 duration-300">
                                    Go Back
                                </span>
                            </button>
                        </div>
                    )}

                    {/* --- عرض المحتوى --- */}
                    {activePage === 'home' && <HomeContent />}
                    {activePage === 'apps' && <AppsListContent />}
                    {activePage === 'dashboard' && <DashboardContent />}
                    
                    {/* عرض صفحة الشحن وتفرعاتها */}
                    {activePage.startsWith('shipping') && <ShippingContent />}
                    
                    {activePage === 'scm' && (
                         <div className="h-[70vh] flex flex-col items-center justify-center text-textSecondary dark:text-darkTextSecondary animate-fade-in">
                            <div className="bg-cardWhite dark:bg-darkCard p-8 rounded-full shadow-soft mb-6 border dark:border-gray-800">
                                {MASTER_APPS_DATA.find(a => a.id === activePage).icon}
                            </div>
                            <h2 className="text-3xl font-bold mb-2 capitalize text-textPrimary dark:text-white">Supply Chain Management</h2>
                            <p className="text-lg">Select a module from the top menu to begin.</p>
                        </div>
                    )}

                    {!['home', 'apps', 'dashboard', 'scm'].includes(basePage) && !activePage.startsWith('shipping') && (
                        <div className="h-[70vh] flex flex-col items-center justify-center text-textSecondary dark:text-darkTextSecondary animate-fade-in">
                            <div className="bg-cardWhite dark:bg-darkCard p-8 rounded-full shadow-soft mb-6 border dark:border-gray-800">
                                {MASTER_APPS_DATA.find(a => a.id === activePage) ? 
                                    MASTER_APPS_DATA.find(a => a.id === activePage).icon 
                                    : <Icon name="construction" size={64} className="text-accentPrimary" />
                                }
                            </div>
                            <h2 className="text-3xl font-bold mb-2 capitalize text-textPrimary dark:text-white">{activePage.replace(/_/g, ' ')}</h2>
                            <p className="text-lg">Module Under Construction</p>
                        </div>
                    )}
                </div>
            </main>
        );
    };

    /* ========================================
    14. تشغيل التطبيق (App Root)
    ========================================
    */
    const App = () => {
        return (
            <AppProvider>
                <div className="flex h-screen w-full font-sans transition-colors duration-300">
                    <DynamicIsland /> <TopHeader /> <ModuleSubHeader /> <SideMenu />
                    <MainLayout />
                </div>
            </AppProvider>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

</body>
</html>